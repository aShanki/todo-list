<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>To-Do List</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1>To-Do List</h1>
        <input type="text" id="taskInput" placeholder="Enter a new task">
        <ul id="taskList"></ul>
        <div class="user-dropdown">
            <span id="usernameDisplay"></span>
            <div class="dropdown">
                <button class="dropbtn">Menu</button>
                <div class="dropdown-content">
                    <a href="#" id="logoutBtn">Logout</a>
                    <a href="#" id="deleteAccountBtn">Delete Account</a>
                </div>
            </div>
        </div>
    </div>

    <div id="deleteAccountModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Confirm Account Deletion</h2>
            <p>Please retype your username to confirm account deletion:</p>
            <input type="text" id="confirmUsername" placeholder="Retype your username">
            <button id="confirmDeleteBtn">Confirm Delete</button>
            <button id="cancelDeleteBtn">Cancel</button>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('token');
        const usernameDisplay = document.getElementById('usernameDisplay');
        const deleteAccountModal = document.getElementById('deleteAccountModal');
        const confirmUsernameInput = document.getElementById('confirmUsername');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        const closeModal = document.querySelector('.close');

        if (!token) {
            window.location.href = 'login.html';
        }

        const parsedToken = JSON.parse(atob(token.split('.')[1]));
        const username = parsedToken.username;
        usernameDisplay.textContent = username;

        const taskInput = document.getElementById('taskInput');
        const taskList = document.getElementById('taskList');

        function loadTasks() {
            fetch('http://localhost:3000/todos', {
                method: 'GET',
                headers: {
                    'Authorization': token
                }
            })
            .then(response => {
                if (response.status === 401) {
                    localStorage.removeItem('token');
                    window.location.href = 'login.html';
                    return;
                }
                return response.json();
            })
            .then(tasks => {
                taskList.innerHTML = '';
                tasks.forEach(task => {
                    const li = document.createElement('li');
                    li.textContent = task.task;
                    li.setAttribute('data-id', task.id);
                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'Delete';
                    deleteButton.onclick = () => deleteTask(task.id);
                    li.appendChild(deleteButton);
                    taskList.appendChild(li);
                });
            });
        }

        taskInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                const task = taskInput.value;
                fetch('http://localhost:3000/todos', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token
                    },
                    body: JSON.stringify({ task })
                }).then(() => {
                    taskInput.value = '';
                    loadTasks();
                });
            }
        });

        function deleteTask(id) {
            fetch(`http://localhost:3000/todos/${id}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': token
                }
            }).then(() => loadTasks());
        }

        document.getElementById('logoutBtn').addEventListener('click', function() {
            localStorage.removeItem('token');
            window.location.href = 'login.html';
        });

        document.getElementById('deleteAccountBtn').addEventListener('click', function() {
            deleteAccountModal.style.display = 'block';
        });

        confirmDeleteBtn.addEventListener('click', function() {
            const confirmUsername = confirmUsernameInput.value;
            if (confirmUsername === username) {
                fetch('http://localhost:3000/users/delete', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token
                    },
                    body: JSON.stringify({ username })
                }).then(() => {
                    localStorage.removeItem('token');
                    window.location.href = 'login.html';
                });
            } else {
                alert('Username does not match. Please try again.');
            }
        });

        cancelDeleteBtn.addEventListener('click', function() {
            deleteAccountModal.style.display = 'none';
        });

        closeModal.onclick = function() {
            deleteAccountModal.style.display = 'none';
        }

        loadTasks();
    </script>
</body>
</html>
