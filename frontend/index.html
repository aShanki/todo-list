<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>To-Do List</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1>To-Do List</h1>
        <input type="text" id="taskInput" placeholder="Enter a new task">
        <div class="task-list-container">
            <ul id="taskList"></ul>
        </div>
        <div class="user-dropdown">
            <span id="usernameDisplay"></span>
            <div class="dropdown">
                <button class="dropbtn">Menu</button>
                <div class="dropdown-content">
                    <a href="#" id="logoutBtn">Logout</a>
                    <a href="#" id="deleteAccountBtn">Delete Account</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Popup Modal for Deleting Account -->
    <div id="deleteAccountModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Confirm Account Deletion</h2>
            <p>Please retype your username to confirm account deletion:</p>
            <input type="text" id="confirmUsername" placeholder="Retype your username">
            <button id="confirmDeleteBtn">Confirm Delete</button>
            <button id="cancelDeleteBtn">Cancel</button>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('token');
        const usernameDisplay = document.getElementById('usernameDisplay');
        const deleteAccountModal = document.getElementById('deleteAccountModal');
        const confirmUsernameInput = document.getElementById('confirmUsername');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        const closeModal = document.querySelector('.close');

        if (!token) {
            window.location.href = 'login.html';
        }

        const parsedToken = JSON.parse(atob(token.split('.')[1]));
        const username = parsedToken.username;
        usernameDisplay.textContent = username;

        const taskInput = document.getElementById('taskInput');
        const taskList = document.getElementById('taskList');

        function loadTasks() {
            fetch('http://localhost:3000/todos', {
                method: 'GET',
                headers: {
                    'Authorization': token
                }
            })
            .then(response => {
                if (response.status === 401) {
                    localStorage.removeItem('token');
                    window.location.href = 'login.html';
                    return;
                }
                return response.json();
            })
            .then(tasks => {
                taskList.innerHTML = '';
                tasks.forEach(task => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <span>${task.task}</span>
                        <button class="deleteBtn" data-task-id="${task.id}">Delete</button>
                    `;
                    taskList.appendChild(li);
                });

                document.querySelectorAll('.deleteBtn').forEach(button => {
                    button.addEventListener('click', deleteTask);
                });
            });
        }

        taskInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && taskInput.value) {
                const newTask = { id: Date.now(), task: taskInput.value };

                fetch('http://localhost:3000/todos', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token
                    },
                    body: JSON.stringify({ task: taskInput.value })
                })
                .then(response => response.json())
                .then(savedTask => {
                    document.querySelector(`[data-task-id="${newTask.id}"]`).setAttribute('data-task-id', savedTask.id);
                })
                .catch(() => {
                    removeTaskFromUI(newTask.id);
                });

                taskInput.value = '';
            }
        });

        function addTaskToUI(task) {
            const li = document.createElement('li');
            li.innerHTML = `
                <span>${task.task}</span>
                <button class="deleteBtn" data-task-id="${task.id}">Delete</button>
            `;
            taskList.appendChild(li);
            li.querySelector('.deleteBtn').addEventListener('click', deleteTask);
        }

        function removeTaskFromUI(taskId) {
            const taskElement = document.querySelector(`[data-task-id="${taskId}"]`);
            if (taskElement) {
                taskElement.parentElement.remove();
            }
        }

        function deleteTask(event) {
            const taskId = event.target.getAttribute('data-task-id');

            fetch(`http://localhost:3000/todos/${taskId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': token
                }
            })
            .then(response => {
                if (response.status === 401) {
                    localStorage.removeItem('token');
                    window.location.href = 'login.html';
                    return;
                }
                if (!response.ok) {
                    loadTasks();
                }
            })
            .catch(() => {
                loadTasks();
            });
        }

        document.getElementById('logoutBtn').addEventListener('click', () => {
            localStorage.removeItem('token');
            window.location.href = 'login.html';
        });

        document.getElementById('deleteAccountBtn').addEventListener('click', () => {
            deleteAccountModal.style.display = 'block';
        });

        closeModal.addEventListener('click', () => {
            deleteAccountModal.style.display = 'none';
        });

        cancelDeleteBtn.addEventListener('click', () => {
            deleteAccountModal.style.display = 'none';
        });

        confirmDeleteBtn.addEventListener('click', () => {
            const confirmUsername = confirmUsernameInput.value;

            if (confirmUsername === username) {
                fetch('http://localhost:3000/users/delete', {
                    method: 'DELETE',
                    headers: {
                        'Authorization': token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        localStorage.removeItem('token');
                        window.location.href = 'register.html';
                    } else {
                        alert('Error deleting account.');
                    }
                });
            } else {
                alert('Username does not match. Please try again.');
            }
        });

        loadTasks();
    </script>
</body>
</html>
